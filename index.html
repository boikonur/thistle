<!doctype html>
<style>
  .swatch {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 1px solid rgba(20,20,20,0.3);
    vertical-align: text-bottom;
  }
  .name {
    font-family: monospace;
  }
  .color {
    cursor: pointer;
    display: inline-block;
  }
</style>
<body>
  <div class='color' id='color'>
    <div class='swatch' style='background-color: beige'></div>
    <span class='name'></span>
  </div>
<script src='picker.js'></script>
<script>
  function cssColorToRGB(cssColor) {
    var s = document.createElement('span')
    document.body.appendChild(s)
    s.style.backgroundColor = cssColor
    var rgb = getComputedStyle(s).backgroundColor
    document.body.removeChild(s)
    var m = /^rgb\((\d+), (\d+), (\d+)\)$/.exec(rgb)
    if (!m) m = /^rgba\((\d+), (\d+), (\d+), ([\d.]+)\)$/.exec(rgb)
    var r = parseInt(m[1]), g = parseInt(m[2]), b = parseInt(m[3])
    if (m[4])
      return {r:r, g:g, b:b, a:parseFloat(m[4])}
    return {r:r, g:g, b:b}
  }
  function presentModalPicker(x, y, cssColor) {
    var rgb = cssColorToRGB(cssColor)
    picker = makePicker({r:rgb.r/255,g:rgb.g/255,b:rgb.b/255})
    picker.el.style.left = x + 'px'
    picker.el.style.top = y-10 + 'px'
    picker.el.style.opacity = '0'
    picker.el.style.webkitTransition = '0.15s'
    picker.el.style.MozTransition = '0.15s'
    var modalFrame = document.createElement('div')
    modalFrame.style.position = 'fixed'
    modalFrame.style.top = modalFrame.style.left = modalFrame.style.bottom = modalFrame.style.right = '0'
    modalFrame.onclick = function() {
      document.body.removeChild(modalFrame)

      picker.el.style.top = y+10+'px'
      picker.el.style.opacity = 0
      picker.el.addEventListener('webkitTransitionEnd', function end() {
        document.body.removeChild(picker.el)
        picker.el.removeEventListener('webkitTransitionEnd', end);
      })
      picker.el.addEventListener('transitionend', function end() {
        document.body.removeChild(picker.el)
        picker.el.removeEventListener('transitionend', end);
      })
    }
    document.body.appendChild(modalFrame)
    document.body.appendChild(picker.el)
    picker.el.offsetHeight;
    picker.el.style.opacity = '1'
    picker.el.style.top = y + 'px'
    return picker
  }
  color.onclick = function(e) {
    var swatch = color.querySelector('.swatch')
    var swatchPos = swatch.getBoundingClientRect()
    var x = swatchPos.left + window.scrollX
    var y = swatchPos.bottom + window.scrollY + 4
    var picker = presentModalPicker(x, y, swatch.style.backgroundColor)
    picker.on('changed', function() {
      var hsl = picker.hsl
      var c = 'hsl('+Math.round(hsl.h)+', '+Math.round(hsl.s*100)+'%, '+Math.round(hsl.l*100)+'%)'
      swatch.style.backgroundColor = c
      color.querySelector('.name').textContent = c
    })
  }

  var h = Math.floor(Math.random()*360)
  var s = Math.random()*0.4+0.5
  var l = Math.random()*0.6+0.3
  var c = 'hsl('+h+', '+Math.round(s*100)+'%, '+Math.round(l*100)+'%)'
  document.querySelector('.swatch').style.backgroundColor = c
  document.querySelector('.name').textContent = c
</script>
